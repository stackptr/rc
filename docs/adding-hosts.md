# Adding New Hosts

This guide explains how to add new hosts (machines) to the Nix configuration.

## Overview

Each host is defined in `hosts/<hostname>/` and registered in `flake.nix`. The system supports both NixOS and macOS (Darwin) hosts with automatic validation.

## Directory Structure

```
hosts/
├── <hostname>/
│   ├── default.nix          # Main host configuration
│   ├── hardware.nix          # Hardware-specific config (NixOS only)
│   ├── key.pub              # SSH public key
│   ├── home.nix             # Host-specific home-manager config (optional)
│   ├── services/            # Host services (optional)
│   └── secrets/             # Host-specific secrets (optional)
```

## Adding a NixOS Host

1. **Create host directory and files**:
   ```bash
   mkdir -p hosts/<hostname>
   ```

2. **Create `hosts/<hostname>/default.nix`**:
   ```nix
   {
     config,
     pkgs,
     hostname,
     username,
     ...
   }: {
     imports = [
       ./hardware.nix
       ./services  # if services directory exists
     ];

     networking.hostName = hostname;
     
     # Host-specific configuration here
   }
   ```

3. **Create `hosts/<hostname>/hardware.nix`**:
   ```nix
   {
     config,
     lib,
     pkgs,
     ...
   }: {
     # Hardware-specific configuration
     # Usually generated by nixos-generate-config
   }
   ```

4. **Add SSH public key**:
   ```bash
   cp ~/.ssh/id_ed25519.pub hosts/<hostname>/key.pub
   ```

5. **Register in `flake.nix`**:
   ```nix
   nixosConfigurations = {
     # ... existing hosts
     <hostname> = mkNixosHost {
       hostname = "<hostname>";
       system = "x86_64-linux";  # or "aarch64-linux"
       username = "<username>";
       allowVpn = true;  # or false
     };
   };
   ```

## Adding a macOS (Darwin) Host

1. **Create host directory and files**:
   ```bash
   mkdir -p hosts/<hostname>
   ```

2. **Create `hosts/<hostname>/default.nix`**:
   ```nix
   {
     config,
     pkgs,
     hostname,
     username,
     ...
   }: {
     networking.hostName = hostname;
     
     # macOS-specific configuration here
   }
   ```

3. **Add SSH public key**:
   ```bash
   cp ~/.ssh/id_ed25519.pub hosts/<hostname>/key.pub
   ```

4. **Register in `flake.nix`**:
   ```nix
   darwinConfigurations = {
     # ... existing hosts
     <hostname> = mkDarwinHost {
       hostname = "<hostname>";
       username = "<username>";
       allowVpn = true;  # or false
     };
   };
   ```

## Host-Specific Configuration

### Home Manager Configuration

Create `hosts/<hostname>/home.nix` for host-specific user configuration:

```nix
{
  config,
  pkgs,
  ...
}: {
  # Host-specific home-manager configuration
  programs.git.userEmail = "user@example.com";
  
  # Additional packages for this host
  home.packages = with pkgs; [
    htop
  ];
}
```

### Services Configuration

For complex service setups, create `hosts/<hostname>/services/`:

```
hosts/<hostname>/services/
├── default.nix       # Imports all service modules
├── web-server.nix    # Web services
├── database.nix      # Database services
└── monitoring.nix    # Monitoring services
```

### Secrets Management

Host-specific secrets go in `hosts/<hostname>/secrets/`:

```bash
mkdir -p hosts/<hostname>/secrets
agenix -e hosts/<hostname>/secrets/example-secret.age
```

Then add to `lib/secrets/<hostname>.nix`:

```nix
{
  "<hostname>" = {
    "example-secret" = ../hosts/<hostname>/secrets/example-secret.age;
  };
}
```

## Validation

The system automatically validates:

- **Hostname format**: Must start with letter, contain only alphanumeric and hyphens
- **Username format**: Must start with lowercase letter, contain only lowercase, numbers, hyphens, underscores
- **System architecture**: Must be valid Nix system
- **Required files**: Ensures `default.nix` exists, `hardware.nix` for NixOS hosts

## Testing

After adding a host, test the configuration:

```bash
# Check configuration syntax
nix flake check

# Build the configuration (don't activate)
nix build .#nixosConfigurations.<hostname>.config.system.build.toplevel  # NixOS
nix build .#darwinConfigurations.<hostname>.system                        # macOS

# Deploy to the host
nixos-rebuild switch --flake .#<hostname>  # NixOS
darwin-rebuild switch --flake .#<hostname>  # macOS
```

## Examples

See existing hosts for examples:
- **zeta**: Raspberry Pi with services
- **glyph**: File server with Samba
- **spore**: Web server with complex nginx setup
- **Rhizome**: macOS workstation

## Common Patterns

- Use `allowVpn = true` for hosts that should have Tailscale VPN access
- Place shared configuration in modules, host-specific config in host directories
- Use descriptive hostnames that reflect the machine's purpose
- Always include SSH public keys for remote access
